---
title: "03_generate-plots"
author: "Nina Rynne"
output: html_document
date: "2023-03-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dev='png', dpi=300, cache=TRUE)

# Libraries and Theme Setup
# -------------------------------------------------------
library(ggplot2)
library(patchwork)
library(tidyverse)
library(dplyr)
library(cowplot)
library(Metrics)
library(qualV)
library(topmodel)
library(plotrix)
library(simplecolors)
library(scales)
library(here)
library(forcats)
library(sf)
library(terra)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggnewscale)
library(stringr)

my_theme <- theme_bw()+
  theme(
    text = element_text(size = 10), # this should be overwritten by the below
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 9),
    axis.text = element_text(size = 8),
    legend.title=element_text(size = 9), 
    legend.text=element_text(size = 8),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
    )


```

```{r arguments}

# Parameters for File and Data Management
# -------------------------------------------------------

# Load lists of parameters from CSV files
esms <- unlist(read.csv(here("data/parameters/esms.csv"), header = FALSE))
mems <- unlist(read.csv(here("data/parameters/mems.csv"), header = FALSE))
element <- unlist(read.csv(here("data/parameters/type.csv"), header = FALSE))
element_long <- unlist(read.csv(here("data/parameters/type_longname.csv"), header = FALSE))
obs <- unlist(read.csv(here("data/parameters/observations.csv"), header = FALSE))

```

```{r load}

# bring in needed dataframes for plotting.

# modelled and observed catch by year, globally
tc_byYear_withWAT_global <- readRDS(here("output/tc_byYear_withWAT_global.rds"))

# modelled and observed catch by year, by LME
tc_byYear_withWAT_LME <- readRDS(here("output/tc_byYear_withWAT_LME.rds"))

# statistical test results by LME
stats_byLME_byModel <- readRDS(here("output/stats_byLME_byModel.rds"))

# statistical test results, globally
stats_global_byModel <- readRDS(here("output/stats_global_byModel.rds"))

# statistical test results by LME, adjusted for shape file to use for map plots
stats_byLME_shaped <- readRDS(here("output/stats_byLME_shaped.rds"))

# observed values only, WAT and SAU
obs_tc_byYear_global <- readRDS(here("output/obs_tc_byYear_global.rds"))

# statistical test results by LME
stats_byLME_byModel <- readRDS(here("output/stats_byLME_byModel.rds"))

# statistical test results, globally
stats_global_byModel <- readRDS(here("output/stats_global_byModel.rds"))

countries_shp <- ne_countries(scale="medium", returnclass = "sf") |> st_transform(crs = "ESRI:54030")

```


```{r boats_CMIP6}

modeldatap1 <- tc_byYear_withWAT_global %>%
  filter(MEMs == 'boats', LME == 0, ESMs == 'gfdl-esm4' | ESMs == 'ipsl-cm6a-lr') 

p1 <- ggplot()+
  geom_line(data = modeldatap1, aes(x = Year, y = Value/1e6, group = Model, color = Model), linewidth = 1.05)+
  geom_line(data = obs_tc_byYear_global, aes(x = Year, y = rec_obs/1e6, group = Source, color = Source), linewidth = 1.25)+
  xlab("\nYear")+
  ylab("Predicted Catch (million tonnes)")+
  my_theme+
  guides(color = guide_legend(title = "BOATS CMIP6", override.aes = list(size = 3)))+
  scale_color_manual(values = c("#0571B0", "#92C5DE", "#CA0020", "#F49582"), labels = c("GFDL-ESM4.1", "IPSL-CMA6-LR", "Watson & Tidd", "Sea Around Us Project"))+
  scale_x_continuous(breaks=seq(1950,2015,20))#+
  #scale_y_continuous(breaks=seq(0,600,50))

p1

modeldatap2 <- tc_byYear_withWAT_global %>%
  filter(MEMs == 'boats', LME == 0, ESMs == 'gfdl-esm4' | ESMs == 'ipsl-cm6a-lr')

p2 <- ggplot()+
  geom_point(data = modeldatap2, aes(x = rec_obs/1e6, y = Value/1e6, group = ESMs, color = ESMs), show.legend = FALSE)+
  my_theme+
  xlab("Observed Catch (million tonnes)")+
  ylab("Predicted Catch (million tonnues")+
  guides(color = guide_legend(title = "Earth System \nModel Forcing:", override.aes = list(size = 3)))+
  scale_color_manual(values = c("#0571B0", "#92C5DE"), labels = c("GFDL-ESM4.1", "IPSL-CM6A-LR"))+
  theme(
    strip.background = element_blank(),
    strip.text.y = element_blank())+
  facet_grid(ESMs ~ .)

p2

(p1 + p2+
    plot_layout(guides = 'collect')+
    plot_annotation(tag_levels = 'A'))

ggsave(filename = here("output/figures/plot_boats_CMIP6.jpg"), dpi = 600, width = 18, height = 9, units = "cm")


```

```{r ecoocean_CMIP6}

modeldatap1 <- tc_byYear_withWAT_global %>%
  filter(MEMs == 'ecoocean', LME == 0, ESMs == 'gfdl-esm4' | ESMs == 'ipsl-cm6a-lr') 

p1 <- ggplot()+
  geom_line(data = modeldatap1, aes(x = Year, y = Value/1e6, group = Model, color = Model), linewidth = 1.05)+
  geom_line(data = obs_tc_byYear_global, aes(x = Year, y = rec_obs/1e6, group = Source, color = Source), linewidth = 1.25)+
  xlab("\nYear")+
  ylab("Predicted Catch (million tonnes)")+
  my_theme+
  guides(color = guide_legend(title = "ecoocean CMIP6", override.aes = list(size = 3)))+
  scale_color_manual(values = c("#31A354", "#A1D99B", "#E6550D", "#FDBE85"), labels = c("GFDL-ESM4.1", "IPSL-CMA6-LR", "Watson & Tidd", "Sea Around Us Project"))+
  scale_x_continuous(breaks=seq(1950,2015,20))#+
  #scale_y_continuous(breaks=seq(0,600,50))

p1

modeldatap2 <- tc_byYear_withWAT_global %>%
  filter(MEMs == 'ecoocean', LME == 0, ESMs == 'gfdl-esm4' | ESMs == 'ipsl-cm6a-lr')

p2 <- ggplot()+
  geom_point(data = modeldatap2, aes(x = rec_obs/1e6, y = Value/1e6, group = ESMs, color = ESMs), show.legend = FALSE)+
  my_theme+
  xlab("Observed Catch (million tonnes)")+
  ylab("Predicted Catch (million tonnues")+
  guides(color = guide_legend(title = "Earth System \nModel Forcing:", override.aes = list(size = 3)))+
  scale_color_manual(values = c("#31A354", "#A1D99B"), labels = c("GFDL-ESM4.1", "IPSL-CM6A-LR"))+
  theme(
    strip.background = element_blank(),
    strip.text.y = element_blank())+
  facet_grid(ESMs ~ .)

p2

(p1 + p2+
    plot_layout(guides = 'collect')+
    plot_annotation(tag_levels = 'A'))

ggsave(filename = here("output/figures/plot_ecoocean_CMIP6.jpg"), dpi = 600, width = 18, height = 9, units = "cm")


```


```{r boxplot_correlation_LME}

corr_data_boats <- stats_byLME_byModel %>%
  filter(MEMs == 'boats')

p1 <- ggplot(corr_data_boats, aes(x = Model, y = Correlation, fill = Model))+
  geom_boxplot()+
  my_theme+
  scale_fill_manual(values = c("#0571B0", "#92C5DE","#CA0020", "#F49582"), 
                    labels = c("BOATS GFDL-ESM2M", 
                               "BOATS GFDL-ESM4", 
                               "BOATS IPSL-CM5A-LR", 
                               "BOATS IPSL-CM6A-LR"))+
  theme(
    strip.background = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank())

corr_data_ecoocean <- stats_byLME_byModel %>%
  filter(MEMs == 'ecoocean')

p2 <- ggplot(corr_data_ecoocean, aes(x = Model, y = Correlation, fill = Model))+
  geom_boxplot()+
  my_theme+
  scale_fill_manual(values = c("#31A354", "#A1D99B", "#E6550D", "#FDBE85"),
                    labels = c("EcoOcean GFDL-ESM2M", 
                               "EcoOcean GFDL-ESM4",
                               "EcoOcean IPSL-CM5A-LR",
                               "EcoOcean IPSL-CM6A-LR"))+
  theme(
    strip.background = element_blank(),
    axis.text.x = element_blank(),
    axis.title.x = element_blank())


(p1 / p2+
    plot_annotation(tag_levels = 'A'))

ggsave(filename = here("output/figures/plot_box_correlation_LME.jpg"), dpi = 600, width = 18, height =18, units="cm")

```