---
title: "02_tabulate-data"
author: "Nina Rynne"
date: "2023-03-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#libraries used

library(tidyr)
library(dplyr)
library(here)
library(stringr)
library(forcats)
library(qualV)
library(topmodel)
library(Metrics)
library(sf)

```

```{r arguments}

# Parameters for File and Data Management
# -------------------------------------------------------

# Load lists of parameters from CSV files
esms <- unlist(read.csv(here("data/parameters/esms.csv"), header = FALSE))
mems <- unlist(read.csv(here("data/parameters/mems.csv"), header = FALSE))
element <- unlist(read.csv(here("data/parameters/type.csv"), header = FALSE))
element_long <- unlist(read.csv(here("data/parameters/type_longname.csv"), header = FALSE))
obs <- unlist(read.csv(here("data/parameters/observations.csv"), header = FALSE))

```

```{r load}

# load model output and reconstructed catch yearly data

modeloutputs_byYear <- read.csv(here("output/modeloutputs_yearly.csv"))
reconstructedWAT_byYear_global <- read.csv(here("output/reconstructedcatch_WAT_global.csv"))
reconstructedSAU_byYear_global <- read.csv(here("output/reconstructedcatch_SAU_global.csv"))
reconstructedWAT_byYear_LME <- read.csv(here("output/reconstructedcatch_WAT_LME.csv"))

# bring in shapefile for map plotting
lme_shapefile = st_read(here("data/shapefile/LMEs66.shp")) 


```

```{r normalised}

tc_byYear_withWAT_global_norm <- modeloutputs_byYear %>%
  filter(Element == "tc_tonnes_year") %>% # only total catch
  filter(LME == "0") %>% # only global level data
  left_join(reconstructedWAT_byYear_global, by = join_by(LME, Year)) %>% # add Watson observations
  mutate("Model" = paste(MEMs, ESMs)) %>% # create column for MEM & ESM combined
  # normalise total catch observations against year 1 (1971 for CMIP5, 1950 for CMIP6)
  group_by(Model) %>%
  mutate(obs_year1 = mean(rec_obs[between(Year, min(Year), min(Year)+4)]),
         rec_obs_norm = 100*(rec_obs - obs_year1)/obs_year1) %>%
  # normalise total catch projections against year 1 (1971 for CMIP5, 1950 for CMIP6)
  mutate(proj_year1 = mean(Value[between(Year, min(Year), min(Year)+4)]),
         proj_tc_norm = 100*(Value - proj_year1)/proj_year1)


tc_byYear_withWAT_LME_norm <- modeloutputs_byYear %>%
  filter(Element == "tc_tonnes_year") %>% # only total catch
  filter(LME != 0) %>% # only LME level data
  left_join(reconstructedWAT_byYear_global, by = join_by(LME, Year)) %>% # add Watson observations
  mutate("Model" = paste(MEMs, ESMs)) %>% # create column for MEM & ESM combined
  # normalise total catch observations against year 1 (1971 for CMIP5, 1950 for CMIP6)
  group_by(LME, Model) %>%
  mutate(obs_year1 = mean(rec_obs[between(Year, min(Year), min(Year)+4)]),
         rec_obs_norm = 100*(rec_obs - obs_year1)/obs_year1) %>%
  # normalise total catch projections against year 1 (1971 for CMIP5, 1950 for CMIP6)
  mutate(proj_year1 = mean(Value[between(Year, min(Year), min(Year)+4)]),
         proj_tc_norm = 100*(Value - proj_year1)/proj_year1)


# create table for reconstructed catch by year data

obs_tc_byYear_global <- rbind(reconstructedSAU_byYear_global, reconstructedWAT_byYear_global) %>%
  group_by(LME, Year, Source) %>%
  mutate(obs_start = mean(rec_obs[between(Year, min(Year), min(Year) + 4)]),
                rec_obs_norm = 100*(rec_obs - obs_start)/obs_start)


```



```{r LME_stats_function}

# function to calculate statistical metrics at LME level, by MEM, by ESM

getLMEStats <- function(mem_name, esm_name) {
  
    # filter data by MEM and ESM
    for(k in 1:66) {
      LMEstats <- tc_byYear_withObs_LME %>%
        filter(MEMs == mem_name,
               ESMs == esm_name,
               LME == k)
      
 # create a vector of results
      LMEstats_vector <- data.frame("MEMs" = mem_name,
                                    "ESMs" = esm_name,
                                    "Variable" = "tc_byYear",
                                    "LME" = k,
                                    "NAME" = unique(LMEstats$NAME),
                                    "Model" = unique(LMEstats$Model),
                                    "Correlation" = cor(LMEstats$rec_obs, LMEstats$Value),
                                    "RMSE" = rmse(LMEstats$rec_obs, LMEstats$Value),
                                    "AAE" = mae(LMEstats$rec_obs, LMEstats$Value),
                                    "Bias" = bias(LMEstats$rec_obs, LMEstats$Value),
                                    "ReliabilityIndex" = GRI(LMEstats$rec_obs, LMEstats$Value),
                                    "ModellingEfficiency" = NSeff(LMEstats$rec_obs, LMEstats$Value)
                                    )
      
      if(!exists("LMEstats_table")) {
        LMEstats_table <- LMEstats_vector
      }else{
        LMEstats_table <- rbind(LMEstats_table, LMEstats_vector)
      } # end if/else loop

    } # end for loop
 
   return(LMEstats_table)
   
  } # end function

```

```{r global_stats_function}

#######################################################
#     NEEDS FIXING


# function to calculate statistical metrics at GLOBAL level, by MEM, by ESM

getGlobalStats <- function(mem_name, esm_name) {

  # filter data by MEM and ESM
  globalstats <- tc_byYear_withObs_global %>%
    filter(MEMs == mem_name,
           ESMs == esm_name,
           Element == "tc_tonnes_year",
           LME == "0") 
  
  # create a vector of results
  globalstats_vector <- data.frame("MEMs" = mem_name,
                                   "ESMs" = esm_name,
                                   "Variable" = "tc_byYear",
                                   "NAME" = "Global",
                                   "Model" = unique(globalstats$Model),
                                   "Correlation" = cor(globalstats$rec_obs, globalstats$Value),
                                   "RMSE" = rmse(globalstats$rec_obs, globalstats$Value),
                                   "AAE" = mae(globalstats$rec_obs, globalstats$Value),
                                   "Bias" = bias(globalstats$rec_obs, globalstats$Value),
                                   "ReliabilityIndex" = GRI(globalstats$rec_obs, globalstats$Value),
                                   "ModellingEfficiency" = NSeff(globalstats$rec_obs, globalstats$Value)
                                   )
  
  return(globalstats_vector)
  
  } # end function

```

```{r call_LME_stats_function}

# call function

for(i in 1:length(mems)){
  for(j in 1:length(esms)){
    
    LMEstats_return <- getLMEStats(mem_name = mems[i],
                                   esm_name = esms[j])
    
    # decide how to handle data returned from function
    
    if(!exists("stats_byLME_byModel")){
        stats_byLME_byModel <- LMEstats_return
      }else{
        stats_byLME_byModel <- rbind(stats_byLME_byModel, LMEstats_return)
      } # end if/else loop

  } # end esm loop
  } # end mem loop

```

```{r call_global_stats_function}

# call function 

for(i in 1:length(mems)){
  for(j in 1:length(esms)){
    
    globalstats_return <- getGlobalStats(mem_name = mems[i],
                                  esm_name = esms[j])
    
    # decide how to handle data returned from function
    
    if(!exists("stats_global_byModel")){
        stats_global_byModel <- globalstats_return
      }else{
        stats_global_byModel <- rbind(stats_global_byModel, globalstats_return)
      } # end if/else loop

  } # end esm loop
  } # end mem loop

```

```{r stats_shapefile}

# merge stats and shapefile for map plotting
stats_byLME_shaped <- merge(
  lme_shapefile,
  stats_byLME_byModel,
  by.y = "NAME",
  by.x = "LME_NAME")

```


```{r save}

# save needed files for plotting

saveRDS(object = mod_tc_byYear, file = here("output/mod_tc_byYear.rds"))
saveRDS(object = stats_byLME_byModel, file = here("output/stats_byLME_byModel.rds"))
saveRDS(object = stats_global_byModel, file = here("output/stats_global_byModel.rds"))
saveRDS(object = stats_byLME_shaped, file = here("output/stats_byLME_shaped.rds"))
saveRDS(object = obs_tc_byYear_global, file = here("output/obs_tc_byYear_global.rds"))

```

```{r export}

# export stats needed for report
write.csv(stats_global_byModel, here("output/globalstats.csv"), row.names = TRUE)


```

```{r other}

write.csv(mod_tc_byYear, here("output/tc_byYear.csv"), row.names = TRUE)

```